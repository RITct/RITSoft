<?php 
	include("includes/connection.php");
?>
<?php
if (isset($_POST["classid"]) && isset($_POST["branch"]) ) {
	$classid=$_POST["classid"];
	$branch=$_POST["branch"];
	

	//enabling first semester
	
	mysql_query("update class_details set active='YES' where concat(courseid,'-',branch_or_specialisation)='$branch' and semid=1") or die(mysql_error());

// disabling last semester
mysql_query("update class_details set active='NO' where classid='$classid'") or die(mysql_error());

// deleting staff advisor of the corresponding class
$ch="select distinct fid from staff_advisor where fid in (select fid from staff_advisor where classid='$classid')";
 $r=mysql_query($ch);
 while($row=mysql_fetch_array($r))
 {
 $fid=$row['fid'];

 $ch1="select * from staff_advisor where fid='$fid'";
	$r1=mysql_query($ch1);
	if (mysql_num_rows($r1)==1){
          
mysql_query("delete from faculty_designation where designation like '%advisor' and fid ='$fid'") or die(mysql_error());

}

mysql_query("delete from staff_advisor where classid='$classid' and fid='$fid'") or die(mysql_error());

}
//** end staff advisor deleting code


//current year..................

$l=mysql_query("select acd_year from academic_year where status=1") or die(mysql_error());
				$r=mysql_fetch_assoc($l);
				$acd_year=$r["acd_year"];
                                $cur=explode('-',$acd_year);
                                 
                                  $y1= $cur[0]-1;
                                  $y2= $cur[1]-1;

                                   $acd_year=$y1."-".$y2; 
                                   
//insert details into current classold......

mysql_query("insert into current_classold(classid,studid,rollno,year) select classid,studid,rollno,'$acd_year' from current_class where classid='$classid'") or die(mysql_error());


// archiving previous details........
mysql_query("insert into sessional_marksold(classid,studid,subjectid,sessional_marks,acd_year) select classid,studid,subjectid,sessional_marks,'$acd_year' from sessional_marks where classid='$classid'") or die(mysql_error());
mysql_query("insert into attendanceold(attid,date,hour,subjectid,classid,studid,status,acd_year) select attid,date,hour,subjectid,classid,studid,status,'$acd_year' from attendance where classid='$classid'") or die(mysql_error());


//deleting from main table
mysql_query("delete from attendance where classid='$classid'") or die(mysql_error());
mysql_query("delete from sessional_marks where classid='$classid'") or die(mysql_error());





//delete from login and current class...
mysql_query("delete from login where username in (select studid from current_class where classid='$classid')") or die(mysql_error());
mysql_query("delete from current_class where classid='$classid'") or die(mysql_error());




//.........................//
//mysql_query("delete from faculty_designation where designation like '%advisor' and fid in(select fid from staff_advisor where //classid='$classid')") or die(mysql_error());
//mysql_query("delete from staff_advisor where classid='$classid'") or die(mysql_error());






	echo "Semester Completed and Started new admission";
}
?>
